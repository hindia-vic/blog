{% extends 'blog/base.html' %}
{% load blog_tags %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<article class="post-detail">
  <header class="mb-4">
    <h1>{{ post.title }}</h1>
    <p class="text-muted">
      Published {{ post.publish }} by {{ post.author }}
      {% if post.updated > post.publish %}
      <span class="text-muted">(Updated {{ post.updated|timesince }} ago)</span>
      {% endif %}
    </p>
  </header>

  <section class="post-content mb-4">
    {{ post.body|markdown }}
  </section>

  <section class="post-actions mb-4">
    <div class="d-flex flex-wrap gap-2">
      <a href='{% url "blog:post_share" post.id %}' class="btn btn-outline-primary">
        <i class="fas fa-share-alt"></i> Share
      </a>

      {% if request.user == post.author or request.user.is_staff %}
      <a href='{% url "blog:update" post.id %}' class="btn btn-outline-secondary">
        <i class="fas fa-edit"></i> Edit
      </a>
      <a href='{% url "blog:post_confirm_delete" post.id %}' class="btn btn-outline-danger">
        <i class="fas fa-trash-alt"></i> Delete
      </a>
      {% endif %}

      {% if user.is_authenticated %}
      <form method="post" action="{% url 'blog:add_to_reading_list' post.id %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-info">
          <i class="fas fa-bookmark"></i>
          {% if post in user.reading_list.posts.all %}
          In Reading List
          {% else %}
          Add to List
          {% endif %}
        </button>
      </form>
      {% endif %}
    </div>
  </section>

  {% if similar_posts %}
  <section class="similar-posts mb-4">
    <h2>Similar posts</h2>
    <div class="list-group">
      {% for post in similar_posts %}
      <a href="{{ post.get_absolute_url }}" class="list-group-item list-group-item-action">
        {{ post.title }}
        <small class="text-muted d-block">{{ post.publish|date:"M j, Y" }}</small>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="comments mt-5">
    <h2 class="mb-4">
      {% with comments.count as total_comments %}
      {{ total_comments }} comment{{ total_comments|pluralize }}
      {% endwith %}
    </h2>
    <div class="comments-container">
      {% if comments %}
      {% for comment in comments %}
      {% if not comment.parent %}
      {% include "blog/post/includes/nested_comment.html" with comment=comment %}
      {% endif %}
      {% endfor %}

      {% else %}
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        No comments yet.
        {% if user.is_authenticated %}
        Be the first to comment!
        {% else %}
        <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">Log in</a> to comment.
        {% endif %}
      </div>
      {% endif %}
    </div>

    {% if user.is_authenticated %}
    {% include "blog/post/includes/comment_form.html" %}
    {% endif %}
  </section>
</article>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.reply-btn').forEach(button => {
      button.addEventListener('click', function () {
        const commentId = this.dataset.commentId;
        const replyForm = document.querySelector(`.reply-form[data-comment-id="${commentId}"]`);

        document.querySelectorAll('.reply-form').forEach(form => {
          form.style.display = 'none';
        });

        if (replyForm.style.display === 'block') {
          replyForm.style.display = 'none';
        } else {
          replyForm.style.display = 'block';
          replyForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    });

    document.querySelectorAll('.cancel-reply').forEach(button => {
      button.addEventListener('click', function () {
        this.closest('.reply-form').style.display = 'none';
      });
    });

    document.querySelectorAll('.ajax-form').forEach(form => {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const commentId = this.dataset.commentId;

        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            }
          });
      });
    });
  });
</script>
{% endblock %}